# Referrals and Rewards

## Overview

Prize-Manager includes a 3-level referral program to help organizers invite other organizers.
When referred users upgrade to Pro, the referrer earns discount coupons (L1/L2/L3).

This doc is the canonical reference for:

- Referral code format + sharing links
- Cross-device capture (URL stripping safe)
- Reward levels and coupon origins
- Admin visibility (`/admin/coupons`, `/admin/martech`)
- Debugging and verification SQL

## Referral Code

- **Format:** `REF-XXXX` (uppercase)
- **Where users get it:** `/account` → "My Referral Code"
- **Generated by:** RPC `get_or_create_my_referral_code`
- **Share link format:** `/auth?mode=signup&ref=REF-XXXX`

## Reward Levels

Rewards are issued when a referred organizer upgrades.

| Level | Who triggers it | Discount | Coupon prefix | coupons.origin |
|------:|------------------|---------:|---------------|----------------|
| L1    | Direct referee upgrades | 100% | `REF1-` | `referral_l1` |
| L2    | Referee's referee upgrades | 50% | `REF2-` | `referral_l2` |
| L3    | 3rd-degree upgrade | 25% | `REF3-` | `referral_l3` |

Notes:

- Rewards are coupons issued to the **beneficiary (referrer)**.
- Coupons are targeted (issued to a specific user/email).

## Cross-device capture (the important part)

Email clients sometimes rewrite/strip query params from confirmation links.
Local storage is device-local, so relying on localStorage alone fails cross-device.
Prize-Manager uses belt-and-suspenders capture:

### At signup

- If the user signs up via `/auth?mode=signup&ref=REF-XXXX`, we persist the referral code in:
  1. `user_metadata.pending_referral_code` (durable cross-device)
  2. localStorage (same-device fallback)
- We also append `?ref=REF-XXXX` to `emailRedirectTo` for extra resiliency.

### After auth (any entry point)

A global hook runs once per authenticated session:

- **Hook:** `src/hooks/useApplyPendingReferral.ts` (wired in `src/App.tsx`)
- **Priority:** URL param → user_metadata → localStorage
- Calls RPC: `apply_referral_code` (idempotent; never blocks login)
- Cleans up: removes localStorage key + clears `user_metadata.pending_referral_code`

## Key DB objects

### Tables

- `referral_codes` — maps `user_id` → `code`
- `referrals` — links `referrer_id` → `referred_id`
  - Snapshot fields for better UX:
    - `referred_email`
    - `referred_label`
- `referral_rewards` — tracks reward issuance (level, beneficiary, trigger user/tournament, coupon_id)
- `coupons` — issued coupons with `origin` and `issued_to_email` snapshots

### Coupon origins used by the system

- `profile_reward`
- `referral_l1`
- `referral_l2`
- `referral_l3`

Admin-created coupons typically have origin `admin` or null.

## Where users see it

### Organizer: /account

- Shows referral code + "Copy referral signup link"
- Shows "Referred Users" list
- Uses referral snapshots (`referred_email` / `referred_label`) first, then profile lookup, then fallback `User …xxxx`

### Admin: /admin/coupons

- System coupons are tagged via `coupons.origin`
- Quick search prefixes: `PROFILE-`, `REF1-`, `REF2-`, `REF3-`
- Coupon details drilldown shows origin-specific context (referral level, trigger user, tournament)

### Admin: /admin/martech

- Referral funnel + drilldowns for referrers/referees
- Uses profile enrichment + safe fallbacks under RLS

## Debug mode

To debug referral capture in the browser:

- Add `?debug_referrals=1` to the URL (works in dev/preview environments)
- Look for `[referral-hook]` console logs showing:
  - Which source was chosen (`url` / `user_metadata` / `localStorage`)
  - Redacted referral code
  - RPC result and any non-blocking errors

## Common failure modes

| Symptom | Likely cause | First check |
|---------|-------------|-------------|
| Referral not in DB after cross-device confirm | `user_metadata.pending_referral_code` not set at signup | Verify `Auth.tsx` passes `pending_referral_code` in `signUp` options |
| Referred user shows as "User …xxxx" | `referred_email` snapshot is null | Check `apply_referral_code` RPC populates snapshot fields |
| Reward coupon not issued after upgrade | Payment not yet approved | Approve payment in `/master-dashboard`; rewards trigger on approval |

See also: [Troubleshooting](./TROUBLESHOOTING.md)

## Verification SQL (read-only)

Use these in the Supabase SQL editor to confirm state:

```sql
-- Latest referral links
SELECT id, referrer_id, referred_id, referred_email, referred_label, created_at
FROM referrals
ORDER BY created_at DESC
LIMIT 20;

-- Latest referral rewards issued
SELECT id, level, reward_type, coupon_id, beneficiary_id, trigger_user_id, trigger_tournament_id, created_at
FROM referral_rewards
ORDER BY created_at DESC
LIMIT 20;

-- Latest system coupons (profile reward + referral)
SELECT code, origin, issued_to_user_id, issued_to_email, created_at
FROM coupons
WHERE origin IN ('profile_reward', 'referral_l1', 'referral_l2', 'referral_l3')
ORDER BY created_at DESC
LIMIT 50;
```

## Related docs

- [Coupons Lifecycle](./COUPONS_LIFECYCLE.md) — coupon states, analytics metrics, security
- [Auth Callback](./AUTH_CALLBACK.md) — PKCE, hash tokens, redirect rules
- [Security & Access Control](./SECURITY_ACCESS_CONTROL.md) — roles, RLS, route guards
- [Troubleshooting](./TROUBLESHOOTING.md) — failure playbooks
