# Rules & Settings Reference (repo-grounded)

This table maps **rule keys** to their **UI location**, **DB storage**, and **code usage**. Any row marked **(unused)** is stored in DB but not used by the allocator today.

| Setting name / key | Allowed values | Default behavior | UI location (route/component) | DB location | Code usage (path → function → line range) |
| --- | --- | --- | --- | --- | --- |
| `rule_config.strict_age` | `true/false` | Default `true` in Settings form. | `/t/:id/settings` → `Settings` (src/pages/Settings.tsx). | `rule_config.strict_age`. | supabase/functions/allocatePrizes/index.ts → `evaluateEligibility`, lines ~1351–1404. |
| `rule_config.allow_missing_dob_for_age` | `true/false` | Default `false` in Settings form. | `/t/:id/settings` → `Settings`. | `rule_config.allow_missing_dob_for_age`. | supabase/functions/allocatePrizes/index.ts → `evaluateEligibility`, lines ~1351–1404. |
| `rule_config.max_age_inclusive` | `true/false` | Default `true` in Settings form. | `/t/:id/settings` → `Settings`. | `rule_config.max_age_inclusive`. | supabase/functions/allocatePrizes/index.ts → `evaluateEligibility`, lines ~1351–1404. |
| `rule_config.age_band_policy` | `non_overlapping`, `overlapping` | Default `non_overlapping` in Settings. | `/t/:id/settings` → `Settings`. | `rule_config.age_band_policy`. | supabase/functions/allocatePrizes/index.ts → `Deno.serve` age-band derivation, lines ~585–666. |
| `rule_config.allow_unrated_in_rating` | `true/false` | Default `false` in Settings. | `/t/:id/settings` → `Settings`. | `rule_config.allow_unrated_in_rating`. | supabase/functions/allocatePrizes/index.ts → `evaluateEligibility`, lines ~1406–1488. |
| `rule_config.main_vs_side_priority_mode` | `place_first`, `main_first` | Default `place_first` in Settings. | `/t/:id/settings` → `Settings`. | `rule_config.main_vs_side_priority_mode`. | supabase/functions/allocatePrizes/index.ts → `makePrizeComparator`, lines ~1623–1659. |
| `rule_config.multi_prize_policy` | `single`, `main_plus_one_side`, `unlimited` | Default `single` in Settings. | `/t/:id/settings` → `Settings`. | `rule_config.multi_prize_policy`. | supabase/functions/allocatePrizes/index.ts → `canPlayerTakePrize`, lines ~314–332. |
| `rule_config.prefer_main_on_equal_value` | `true/false` | Legacy fallback; when `main_vs_side_priority_mode` is missing, this is mapped to `main_first` vs `place_first`. | Not exposed in UI. | `rule_config.prefer_main_on_equal_value`. | supabase/functions/allocatePrizes/index.ts → `Deno.serve` rule merge, lines ~576–584. |
| `rule_config.category_priority_order` **(unused)** | JSON array | Stored but not read by allocator. | Not exposed in UI. | `rule_config.category_priority_order`. | **Unused** in allocation code (no reads outside Settings/ConflictReview). |
| `rule_config.prefer_category_rank_on_tie` **(unused)** | `true/false` | Stored but not read by allocator. | Not exposed in UI. | `rule_config.prefer_category_rank_on_tie`. | **Unused** in allocation code (no reads outside ConflictReview). |
| `rule_config.tie_break_strategy` **(API-only)** | `rating_then_name`, `none`, or array `['rating','name']` | Default `rating_then_name` in allocator; can be overridden per API call. | No UI. Override via `allocatePrizes` request body. | **Not present** in DB types. | supabase/functions/allocatePrizes/index.ts → `normalizeTieBreakStrategy`, lines ~24–30; `Deno.serve`, lines ~560–573. |
| `categories.criteria_json.min_age` / `max_age` | Integer ages | No defaults; enforced only when present and `strict_age` is on. | Category criteria sheet in Tournament Setup. | `categories.criteria_json`. | supabase/functions/allocatePrizes/index.ts → `evaluateEligibility`, lines ~1351–1404. |
| `categories.criteria_json.gender` | `F`, `M_OR_UNKNOWN`, or empty (open) | Empty = open; youngest categories override via `category_type`. | Category criteria sheet in Tournament Setup. | `categories.criteria_json`. | supabase/functions/allocatePrizes/index.ts → `evaluateEligibility`, lines ~1316–1350. |
| `categories.criteria_json.min_rating` / `max_rating` | Integers | No defaults; enforced when set. | Category criteria sheet in Tournament Setup. | `categories.criteria_json`. | supabase/functions/allocatePrizes/index.ts → `evaluateEligibility`, lines ~1406–1488. |
| `categories.criteria_json.include_unrated` | `true/false` | Overrides legacy unrated handling when set. | Category criteria sheet in Tournament Setup. | `categories.criteria_json`. | supabase/functions/allocatePrizes/index.ts → `evaluateEligibility`, lines ~1406–1488. |
| `categories.criteria_json.unrated_only` | `true/false` | When `true`, rated players are excluded. | Category criteria sheet in Tournament Setup. | `categories.criteria_json`. | supabase/functions/allocatePrizes/index.ts → `evaluateEligibility`, lines ~1406–1488. |
| `categories.criteria_json.allowed_states` / `allowed_cities` / `allowed_clubs` | Arrays of strings | Only enforced when list is non‑empty. | Category criteria sheet in Tournament Setup. | `categories.criteria_json`. | supabase/functions/allocatePrizes/index.ts → `matchesLocation`, lines ~1216–1262; `evaluateEligibility`, lines ~1490–1526. |
| `categories.criteria_json.allowed_groups` / `allowed_types` | Arrays of strings | Only enforced when list is non‑empty. | Category criteria sheet in Tournament Setup. | `categories.criteria_json`. | supabase/functions/allocatePrizes/index.ts → `evaluateEligibility`, lines ~1488–1514. |
| `categories.criteria_json.allowed_disabilities` | Arrays of strings | Only enforced when list is non‑empty. | Category criteria sheet in Tournament Setup. | `categories.criteria_json`. | supabase/functions/allocatePrizes/index.ts → `evaluateEligibility`, lines ~1488–1514. |
| `categories.criteria_json.category_type` | `standard`, `youngest_female`, `youngest_male` | Default `standard`. | Category criteria sheet in Tournament Setup. | `categories.criteria_json`. | supabase/functions/allocatePrizes/index.ts → `isYoungestCategory`, lines ~1718–1721. |
| `institution_prize_groups.group_by` | `club`, `city`, `state`, `group_label`, `type_label` | Default `club` in Team Prize Rules sheet. | Tournament Setup → Team Prize Rules sheet. | `institution_prize_groups.group_by`. | supabase/functions/allocateInstitutionPrizes/index.ts → `GROUP_BY_COLUMN_MAP`, lines ~125–132. |
| `institution_prize_groups.team_size`, `female_slots`, `male_slots` | Integers | Defaults to 4/0/0 in Team Prize Rules sheet. | Tournament Setup → Team Prize Rules sheet. | `institution_prize_groups.*`. | supabase/functions/allocateInstitutionPrizes/index.ts → `buildTeam`, lines ~195–259. |
| `institution_prize_groups.scoring_mode` | `by_top_k_score` | Only option today. | Tournament Setup → Team Prize Rules sheet. | `institution_prize_groups.scoring_mode`. | supabase/functions/allocateInstitutionPrizes/index.ts → scoring loop in `Deno.serve`, lines ~481–552. |

## Notes
- **Manual overrides** are entered in the Review Allocations UI and sent directly to `allocatePrizes` (not stored as settings). (src/pages/ConflictReview.tsx → `allocateMutation`, lines ~184–226)
- **Public results** use only published tournaments via the `published_tournaments` view. (supabase/migrations/20251226184159_c2405569-73f6-4622-827f-3183c54b8645.sql → `CREATE VIEW public.published_tournaments`, lines ~6–28; src/pages/PublicResults.tsx → `PublicResults`, lines ~28–120)
